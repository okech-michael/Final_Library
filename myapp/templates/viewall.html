{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Recommended Books — Virtual Library</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .book-card { transition: transform .12s ease; }
    .book-card:hover { transform: translateY(-4px); }
    .cover { width: 100%; height: 210px; object-fit: cover; border-radius: 6px; }
    .truncate { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h3">Recommended for you</h1>
      <div class="w-50">
        <input id="search" class="form-control" placeholder="Search title, author, tag...">
      </div>
    </div>

    {% comment %} quick filter & sort controls {% endcomment %}
    <div class="row mb-3 gx-2 gy-2">
      <div class="col-auto">
        <select id="sort" class="form-select">
          <option value="-score">Recommended (best)</option>
          <option value="-rating">Rating (high → low)</option>
          <option value="title">Title (A → Z)</option>
          <option value="author">Author (A → Z)</option>
        </select>
      </div>
      <div class="col-auto">
        <select id="availability" class="form-select">
          <option value="all">All</option>
          <option value="free">Free</option>
          <option value="paid">Paid</option>
        </select>
      </div>
    </div>

    {% if recommended_books %}
    <div id="books-grid" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3">
      {% for book in recommended_books %}
      <div class="col book-item" data-title="{{ book.title|lower }}" data-author="{{ book.author|lower }}" data-tags="{{ book.tags|join:\",\"|lower }}" data-rating="{{ book.rating|default:0 }}" data-price="{{ book.price|default:0 }}" data-score="{{ book.recommendation_score|default:0 }}">
        <div class="card book-card h-100 shadow-sm">
          <img src="{{ book.cover_url|default:static('images/default_cover.png') }}" alt="{{ book.title }} cover" class="cover card-img-top">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title mb-1">{{ book.title }}</h5>
            <p class="text-muted small mb-2">by {{ book.author }}</p>
            <p class="card-text small truncate mb-2">{{ book.description|default:"No description available." }}</p>
            <div class="mt-auto">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                  <span class="badge bg-info text-dark">⭐ {{ book.rating|default:"0.0" }}</span>
                  {% if book.tags %}
                    {% for tag in book.tags|slice:":3" %}
                      <span class="badge bg-secondary ms-1">{{ tag }}</span>
                    {% endfor %}
                  {% endif %}
                </div>
                <div>
                  {% if book.price and book.price|float > 0 %}
                    <span class="fw-bold">Ksh {{ book.price }}</span>
                  {% else %}
                    <span class="text-success">Free</span>
                  {% endif %}
                </div>
              </div>

              <div class="d-flex gap-2">
                <a href="{% url 'book_detail' book.id %}" class="btn btn-sm btn-outline-primary w-100">View</a>
                <form method="post" action="{% url 'add_to_reading_list' book.id %}">{% csrf_token %}
                  <button class="btn btn-sm btn-primary w-100" type="submit">Save</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
      <div class="alert alert-info">No recommendations at the moment. Try exploring categories or update your reading preferences.</div>
    {% endif %}

  </div>

  <script>
    // Simple client-side search/filter/sort to improve UX while server-side handles canonical ordering
    const searchInput = document.getElementById('search');
    const sortSelect = document.getElementById('sort');
    const availability = document.getElementById('availability');
    const grid = document.getElementById('books-grid');

    function getItems() { return Array.from(grid ? grid.querySelectorAll('.book-item') : []); }

    function applyFilters() {
      const q = searchInput.value.trim().toLowerCase();
      const availabilityVal = availability.value;
      getItems().forEach(item => {
        const title = item.dataset.title || '';
        const author = item.dataset.author || '';
        const tags = item.dataset.tags || '';
        const price = parseFloat(item.dataset.price || '0');
        const matchesQ = q === '' || title.includes(q) || author.includes(q) || tags.includes(q);
        const matchesAvailability = availabilityVal === 'all' || (availabilityVal === 'free' && price === 0) || (availabilityVal === 'paid' && price > 0);
        item.style.display = (matchesQ && matchesAvailability) ? '' : 'none';
      });
      applySort();
    }

    function applySort() {
      const val = sortSelect.value;
      const items = getItems().filter(i => i.style.display !== 'none');
      const parent = grid;
      const getKey = (item) => {
        if (val === '-rating') return -parseFloat(item.dataset.rating || 0);
        if (val === 'title') return (item.dataset.title || '');
        if (val === 'author') return (item.dataset.author || '');
        if (val === '-score') return -parseFloat(item.dataset.score || 0);
        return 0;
      }
      items.sort((a,b) => {
        const A = getKey(a);
        const B = getKey(b);
        if (typeof A === 'number') return A - B;
        return A.localeCompare(B);
      });
      items.forEach(it => parent.appendChild(it));
    }

    [searchInput, sortSelect, availability].forEach(el => el && el.addEventListener('input', applyFilters));
  </script>
</body>
</html>
{% load static %}